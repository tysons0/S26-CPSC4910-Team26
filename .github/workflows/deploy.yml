name: Deploy .NET API to EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Publish
      run: dotnet publish -c Release -r linux-x64 --self-contained false -o publish

    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "publish/*"
        target: "/var/www/team26api"

    - name: Write environment file and restart service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          sudo bash -c 'cat > /etc/team26api.env <<EOF
          DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          VERSION=${{ github.run_number }}
          COMMIT_NAME=${{ github.sha }}
          GIT_TAG=${{ github.ref_type == 'tag' && github.ref_name || 'none' }}
          
          # Add your real app variables below:
          ASPNETCORE_ENVIRONMENT=Production
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          CONNECTION_STRING=${{ secrets.CONNECTION_STRING }}
          EOF'

          sudo chmod 644 /etc/team26api.env
          sudo systemctl daemon-reload
          sudo systemctl restart team26api

    - name: Verify service is running
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          sleep 5
          sudo systemctl is-active --quiet team26api || exit 1
